# IBKR MF Syncer
Sync the stock portfolio in IBKR to MoneyForward ME.

IBKR MF Syncer is a Python script that synchronizes a stock portfolio from [Interactive Brokers (IBKR)](https://www.interactivebrokers.com/) with [MoneyForward ME](https://moneyforward.com/). The script fetches reports in XML format generated by IBKR [Flex Queries](https://www.interactivebrokers.com/en/software/singlefunds/topics/flexqueries.htm#:~:text=Flex%20Queries%20let%20you%20specify,want%20to%20view%20your%20report.) and reflects the information to MoneyForward ME.

## Constraints
- Only supports Cash balance, Physical Stocks, and Options. Other products (bonds, investment trusts, futures, CFDs, etc.) are not (yet) supported.
- Uses exchange rate information obtained from Yahoo Finance for yen conversion, but it's not very accurate and should be considered approximate.
- The Token for Interactive Brokers (IBKR)'s Flex web service is not valid indefinitely. It has a validity period of 1 year. Please note that you will need to set it up again once it expires.

## Preparation
- Preparation on the IB Securities side:
  - [Enable the Flex web service](https://www.interactivebrokers.com/campus/ibkr-api-page/flex-web-service/) in your IB Securities account settings.
  - Once enabled, make a note of the [Current Token](https://www.ibkrguides.com/clientportal/flex3.htm).
  - [Create one Activity Flex query](https://www.ibkrguides.com/clientportal/performanceandstatements/activityflex.htm). Select only the following two sections (1) and (2). Do not select any other sections.
    - (1) [Open Position](https://ibkrguides.com/reportingreference/reportguide/openpositions_default.htm)
       - Select only the "Summary" option.
       - Select all items (SELECT ALL).
    - (2) [Cash Report](https://ibkrguides.com/reportingreference/reportguide/cashreport_default.htm)
       - Do not select any options.
       - Select all items (SELECT ALL).
    - Leave all other settings as default.
    - The query name can be anything.
    - After creation, make a note of that query ID.
- MoneyForward ME settings:
  - [Manually register "IB Securities" as a financial institution (securities) that does not support automatic acquisition](https://support.me.moneyforward.com/hc/ja/articles/900004425703-%E8%87%AA%E5%8B%95%E5%8F%96%E5%BE%97%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E9%87%91%E8%9E%8D%E6%A9%9F%E9%96%A2%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%81%84) in MoneyForward ME.
  - You can register from [here](https://moneyforward.com/accounts/new/manual?category_type=SEC). The "Financial Institution Name" can be anything. e.g., IBKR
  - After registration, go to [【Accounts】→【Registered Financial Institutions】](https://moneyforward.com/accounts), and you should see "IBKR" in the "Cash and Assets on Hand" section. Click on it and make a note of the URL.

## How to Use

### Configuration

This application supports two configuration methods (in order of precedence):

1. **Environment Variables (Recommended for production/Lambda)**
2. **config.ini file (Local development fallback)**

#### Option 1: Environment Variables (Recommended)

Set the following environment variables:

```bash
# Linux/macOS
export MF_EMAIL="your_email@example.com"
export MF_PASSWORD="your_password"
export MF_IB_INSTITUTION_URL="https://moneyforward.com/accounts/show_manual/YOUR_INSTITUTION_ID"
export IBKR_FLEX_TOKEN="your_token"
export IBKR_FLEX_QUERY_ID="your_query_id"

# Windows (Command Prompt)
set MF_EMAIL=your_email@example.com
set MF_PASSWORD=your_password
set MF_IB_INSTITUTION_URL=https://moneyforward.com/accounts/show_manual/YOUR_INSTITUTION_ID
set IBKR_FLEX_TOKEN=your_token
set IBKR_FLEX_QUERY_ID=your_query_id

# Windows (PowerShell)
$env:MF_EMAIL="your_email@example.com"
$env:MF_PASSWORD="your_password"
$env:MF_IB_INSTITUTION_URL="https://moneyforward.com/accounts/show_manual/YOUR_INSTITUTION_ID"
$env:IBKR_FLEX_TOKEN="your_token"
$env:IBKR_FLEX_QUERY_ID="your_query_id"
```

Alternatively, copy `.env.template` to `.env` and fill in your credentials (`.env` is gitignored):

```bash
cp .env.template .env
# Edit .env with your credentials
```

**Note**: For AWS Lambda deployment, set these as Lambda environment variables or use AWS Secrets Manager.

#### Option 2: config.ini File (Fallback)

If environment variables are not set, the application will fall back to `config.ini`:

1. Rename or Duplicate `config.ini.template` to `config.ini`
2. Reflect all the information you noted during preparation in `config.ini` and save it.

**Important**: Never commit `config.ini` or `.env` to version control.

### Installation and Execution

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Install Playwright browsers:
```bash
playwright install
```

3. Run the script:
```bash
python main.py
```

## Libraries

The following libraries are required:
- configparser
- playwright
- ibflex
- pandas
- BeautifulSoup4
- yfinance

You can install them with the following command:

```bash
pip install configparser playwright ibflex pandas beautifulsoup4 yfinance
```
