# IBKR MF Syncer
Sync the stock portfolio in IBKR to MoneyForward ME.

IBKR MF Syncer is a Python script that synchronizes a stock portfolio from [Interactive Brokers (IBKR)](https://www.interactivebrokers.com/) with [MoneyForward ME](https://moneyforward.com/). The script fetches reports in XML format generated by IBKR [Flex Queries](https://www.interactivebrokers.com/en/software/singlefunds/topics/flexqueries.htm#:~:text=Flex%20Queries%20let%20you%20specify,want%20to%20view%20your%20report.) and reflects the information to MoneyForward ME.

## Constraints
- Only supports Cash balance, Physical Stocks, and Options. Other products (bonds, investment trusts, futures, CFDs, etc.) are not (yet) supported.
- Uses exchange rate information obtained from Yahoo Finance for yen conversion, but it's not very accurate and should be considered approximate.
- The Token for Interactive Brokers (IBKR)'s Flex web service is not valid indefinitely. It has a validity period of 1 year. Please note that you will need to set it up again once it expires.

## Preparation
- Preparation on the IB Securities side:
  - [Enable the Flex web service](https://www.ibkrguides.com/brokerportal/flexwebservice.htm#:~:text=To%20enable%20flex%20web%20service,or%20disable%20Flex%20Web%20Service.) in your IB Securities account settings.
  - Once enabled, make a note of the [Current Token](https://www.ibkrguides.com/clientportal/flex3.htm).
  - [Create one Activity Flex query](https://www.ibkrguides.com/clientportal/performanceandstatements/activityflex.htm). Select only the following two sections (1) and (2). Do not select any other sections.
    - (1) [Open Position](https://ibkrguides.com/reportingreference/reportguide/openpositions_default.htm)
       - Select only the "Summary" option.
       - Select all items (SELECT ALL).
    - (2) [Cash Report](https://ibkrguides.com/reportingreference/reportguide/cashreport_default.htm)
       - Do not select any options.
       - Select all items (SELECT ALL).
    - (3) [Net Asset Value](https://ibkrguides.com/reportingreference/reportguide/netassetvalue_default.htm)
       - Do not select any options.
       - Select all items (SELECT ALL).
    - Leave all other settings as default.
    - The query name can be anything.
    - After creation, make a note of that query ID.
- MoneyForward ME settings:
  - [Manually register "IB Securities" as a financial institution (securities) that does not support automatic acquisition](https://support.me.moneyforward.com/hc/ja/articles/900004425703-%E8%87%AA%E5%8B%95%E5%8F%96%E5%BE%97%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E9%87%91%E8%9E%8D%E6%A9%9F%E9%96%A2%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E3%81%84) in MoneyForward ME.
  - You can register from [here](https://moneyforward.com/accounts/new/manual?category_type=SEC). The "Financial Institution Name" can be anything. e.g., IBKR
  - After registration, go to [【Accounts】→【Registered Financial Institutions】](https://moneyforward.com/accounts), and you should see "IBKR" in the "Cash and Assets on Hand" section. Click on it and make a note of the URL.

## How to Use

1. First, reflect all the information you noted during preparation in `config.ini` and save it.
2. Execute playwright to install browser(s)
```
playwright install
```
3. Next, run the script.
```bash
python main.py
```

## Libraries

The following libraries are required:
- configparser
- playwright
- ibflex
- pandas
- BeautifulSoup4
- yfinance

You can install them with the following command:

```bash
pip install configparser playwright ibflex pandas beautifulsoup4 yfinance
```
